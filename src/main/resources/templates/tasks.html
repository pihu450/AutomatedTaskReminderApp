<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>All Tasks</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
          rel="stylesheet">

    <link rel="stylesheet" th:href="@{/css/styles.css}">
</head>

<body>
<h2 align="center">TASK REMINDER APPLICATION </h2><br>

<div class="container">

    <h2>All Tasks</h2>


    <!-- FLASH MESSAGES -->

    <div th:if="${success}" class="alert alert-success text-center">
        <span th:text="${success}"></span>
    </div>

    <div th:if="${error}" class="alert alert-danger text-center">
        <span th:text="${error}"></span>
    </div>


    <!-- FILTER / SEARCH -->
    <form class="filters" th:action="@{/api/tasks/tasks}" method="get">

        <label>Status:</label>
        <select name="status" class="filter-input">
            <option value="">All</option>
            <option th:each="s : ${T(com.tracker.app.enums.TaskStatus).values()}"
                    th:value="${s}"
                    th:text="${s}"
                    th:selected="${status == s}">
            </option>
        </select>

        <label>Priority:</label>
        <select name="priority" class="filter-input">
            <option value="">All</option>
            <option th:each="p : ${T(com.tracker.app.enums.TaskPriority).values()}"
                    th:value="${p}"
                    th:text="${p}"
                    th:selected="${priority == p}">
            </option>
        </select>

        <label>Search:</label>
        <input type="text"
               name="keyword"
               class="filter-input"
               placeholder="Search by title"
               th:value="${keyword}"/>

        <button type="submit" class="btn btn-secondary">Search</button>
        <a th:href="@{/api/tasks/add}" class="btn btn-success">Add Task</a>
        <a th:href="@{/api/tasks/tasks}" class="btn btn-primary">Clear</a>
        <button type="button"
                id="toggleCalendarBtn"
                class="btn btn-secondary">
            üìÖ Open Calendar
        </button>
    </form>


    <!-- ================= CALENDAR ================= -->
    <div class="calendar-wrapper calendar-fix">



    <h3>üìÖ Task Calendar</h3>

        <div class="calendar-header">
            <button id="prevMonth">‚Üê</button>
            <span id="monthYear"></span>
            <button id="nextMonth">‚Üí</button>
        </div>

        <!-- LEGEND -->
        <div class="calendar-legend">
            <span class="legend high">High</span>
            <span class="legend medium">Medium</span>
            <span class="legend low">Low</span>
        </div>

        <div class="calendar-weekdays">
            <span>Sun</span><span>Mon</span><span>Tue</span>
            <span>Wed</span><span>Thu</span><span>Fri</span><span>Sat</span>
        </div>

        <div class="calendar-grid" id="calendarGrid"></div>
    </div>

    <!-- SELECTED DATE TASKS -->
    <div class="selected-date-box">
        <h3 id="selectedDateTitle">üìå Click a date to see tasks</h3>
        <ul id="selectedTaskList"></ul>
    </div>

    <!-- ================= TASK TABLE ================= -->
    <table class="task-table">
        <thead>
        <tr>
            <th>ID</th>
            <th>Title</th>
            <th>Description</th>
            <th>Due Date</th>
            <th>Status</th>
            <th>Priority</th>
            <th>Created At</th>
            <th>Actions</th>
        </tr>
        </thead>

        <tbody>
        <tr th:if="${tasks.empty}">
            <td colspan="8">No tasks found</td>
        </tr>

        <tr th:each="task : ${tasks}">
            <td th:text="${task.id}"></td>
            <td th:text="${task.title}"></td>
            <td th:text="${task.description}"></td>
            <td th:text="${#temporals.format(task.dueDate, 'dd-MM-yyyy')}"></td>
            <td th:text="${task.status}"></td>
            <td th:text="${task.priority}"></td>
            <td th:text="${#temporals.format(task.createdAt, 'dd-MM-yyyy HH:mm')}"></td>
            <td class="actions">
                <a th:href="@{/api/tasks/view/{id}(id=${task.id})}">View</a>
                <a th:href="@{/api/tasks/edit/{id}(id=${task.id})}">Edit</a>
                <a th:href="@{/api/tasks/markdone/{id}(id=${task.id})}">Mark Done</a>
                <a th:href="@{/api/tasks/delete/{id}(id=${task.id})}"
                   onclick="return confirm('Delete this task?');">Delete</a>
            </td>
        </tr>
        </tbody>
    </table>

    <!-- PAGINATION -->
    <div class="pagination">
        <a th:if="${taskPage.hasPrevious()}"
           th:href="@{/api/tasks/tasks(
        page=${taskPage.number - 1},
        size=${taskPage.size},
        keyword=${keyword},
        status=${status},
        priority=${priority},
        dueDate=${dueDate}
   )}"
           class="btn btn-secondary">
            Previous
        </a>


        <span>Page <b th:text="${taskPage.number + 1}"></b> /
              <b th:text="${taskPage.totalPages}"></b></span>

        <a th:if="${taskPage.hasNext()}"
           th:href="@{/api/tasks/tasks(
        page=${taskPage.number + 1},
        size=${taskPage.size},
        keyword=${keyword},
        status=${status},
        priority=${priority},
        dueDate=${dueDate}
   )}"
           class="btn btn-secondary">
            Next
        </a>

    </div>

</div>

<!-- ================= TASK DATA ================= -->
<script th:inline="javascript">
    const tasks = [[${tasks}]];
</script>

<!-- ================= CALENDAR SCRIPT ================= -->
<script>
    function formatDate(dueDate) {
        if (!dueDate) return null;

        if (typeof dueDate === "string") {
            return dueDate.substring(0, 10);
        }

        if (dueDate.year && dueDate.monthValue && dueDate.dayOfMonth) {
            return `${dueDate.year}-${String(dueDate.monthValue).padStart(2,'0')}-${String(dueDate.dayOfMonth).padStart(2,'0')}`;
        }
        return null;
    }

    let currentDate = new Date();

    function renderCalendar() {
        const grid = document.getElementById("calendarGrid");
        grid.innerHTML = "";

        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        const today = new Date();

        document.getElementById("monthYear").innerText =
            currentDate.toLocaleDateString("en-US", { month: "long", year: "numeric" });

        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();

        for (let i = 0; i < firstDay; i++) {
            const empty = document.createElement("div");
            empty.className = "calendar-day";
            empty.style.visibility = "hidden";
            grid.appendChild(empty);
        }

        for (let day = 1; day <= daysInMonth; day++) {
            const cell = document.createElement("div");
            cell.className = "calendar-day";

            if (
                day === today.getDate() &&
                month === today.getMonth() &&
                year === today.getFullYear()
            ) {
                cell.classList.add("today");
            }

            cell.innerHTML = `<strong>${day}</strong>`;
            const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;

          cell.onclick = () => {
    document.querySelector(".selected-date-box").style.display = "block";

    const list = document.getElementById("selectedTaskList");
    const title = document.getElementById("selectedDateTitle");
    list.innerHTML = "";
    title.innerText = `üìå Tasks on ${dateStr}`;

    let found = false;

    tasks.forEach(t => {
        if (formatDate(t.dueDate) === dateStr) {
            const li = document.createElement("li");

            li.innerHTML = `
                <strong>${t.title}</strong>
                <span class="badge priority-${t.priority}">${t.priority}</span>
                <span class="badge status-${t.status}">
                    ${t.status.replace("_"," ")}
                </span>
            `;

            list.appendChild(li);
            found = true;
        }
    });

    if (!found) {
        const li = document.createElement("li");
        li.style.color = "#64748b";
        li.innerText = "No tasks for this date";
        list.appendChild(li);
    }
};

            tasks.forEach(t => {
                if (formatDate(t.dueDate) === dateStr) {
                    const taskDiv = document.createElement("div");
                    taskDiv.className = `cal-task ${t.priority}`;
                    taskDiv.innerText = t.title;
                    cell.appendChild(taskDiv);
                }
            });

            grid.appendChild(cell);
        }
    }

    document.getElementById("prevMonth").onclick = () => {
        currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar();
    };

    document.getElementById("nextMonth").onclick = () => {
        currentDate.setMonth(currentDate.getMonth() + 1);
         renderCalendar();
    };


</script>
<script>
    const toggleBtn = document.getElementById("toggleCalendarBtn");
    const calendarWrapper = document.querySelector(".calendar-wrapper");

    let isCalendarOpen = false;

    toggleBtn.onclick = () => {
        isCalendarOpen = !isCalendarOpen;

        if (isCalendarOpen) {
            calendarWrapper.classList.add("open");
            toggleBtn.innerText = "‚ùå Close Calendar";
            renderCalendar(); // render only when opened
        } else {
            calendarWrapper.classList.remove("open");
            toggleBtn.innerText = "üìÖ Open Calendar";
        }
    };
</script>


</body>
</html>
