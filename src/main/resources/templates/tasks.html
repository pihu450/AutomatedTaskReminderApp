<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>All Tasks | Task Reminder</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
          rel="stylesheet">

    <!-- Custom CSS -->
    <link rel="stylesheet" th:href="@{/css/styles.css}">
</head>

<body>

<!-- ================= NAVBAR ================= -->
<div th:replace="~{fragments/layout :: navbar}"></div>

<!-- ================= PAGE CONTENT ================= -->
<div class="page-content">
    <div class="app-container">

        <!-- Page Title -->
        <h2 class="text-center mb-4">TASK REMINDER APPLICATION</h2>

        <h3 class="mb-3">All Tasks</h3>

        <!-- ================= FLASH MESSAGES ================= -->
        <div th:if="${success}" class="alert alert-success text-center">
            <span th:text="${success}"></span>
        </div>

        <div th:if="${error}" class="alert alert-danger text-center">
            <span th:text="${error}"></span>
        </div>

        <!-- ================= FILTERS ================= -->
        <form class="filters" th:action="@{/api/tasks/tasks}" method="get">

            <label>Status:</label>
            <select name="status" class="filter-input">
                <option value="">All</option>
                <option th:each="s : ${T(com.tracker.app.enums.TaskStatus).values()}"
                        th:value="${s}"
                        th:text="${s}"
                        th:selected="${status == s}">
                </option>
            </select>

            <label>Priority:</label>
            <select name="priority" class="filter-input">
                <option value="">All</option>
                <option th:each="p : ${T(com.tracker.app.enums.TaskPriority).values()}"
                        th:value="${p}"
                        th:text="${p}"
                        th:selected="${priority == p}">
                </option>
            </select>

            <label>Search:</label>
            <input type="text"
                   name="keyword"
                   class="filter-input"
                   placeholder="Search by title"
                   th:value="${keyword}"/>

            <button type="submit" class="btn btn-secondary">Search</button>

            <a th:if="${session.userId != null}"
               th:href="@{/api/tasks/add}"
               class="btn btn-success">
                Add Task
            </a>

            <a th:href="@{/api/tasks/tasks}" class="btn btn-primary">Clear</a>

            <button type="button" id="toggleCalendarBtn" class="btn btn-secondary">
                üìÖ Open Calendar
            </button>
        </form>

        <!-- ================= EXPORT ================= -->
        <div class="mb-3">
            <a th:href="@{/api/tasks/export(exportway='download')}"
               class="btn btn-outline-primary me-2">
                Export CSV
            </a>

            <a th:href="@{/api/tasks/export/email}"
               class="btn btn-outline-success">
                Export CSV to Email
            </a>
        </div>

        <!-- ================= CALENDAR ================= -->
        <div class="calendar-wrapper">

            <div class="calendar-container">
                <h4 class="calendar-title">üìÖ Task Calendar</h4>

            <div class="calendar-header">
                <button id="prevMonth">‚Üê</button>
                <span id="monthYear"></span>
                <button id="nextMonth">‚Üí</button>
            </div>

            <div class="calendar-legend">
                <span class="legend high">High</span>
                <span class="legend medium">Medium</span>
                <span class="legend low">Low</span>
            </div>

            <div class="calendar-weekdays">
                <span>Sun</span><span>Mon</span><span>Tue</span>
                <span>Wed</span><span>Thu</span><span>Fri</span><span>Sat</span>
            </div>

            <div class="calendar-grid" id="calendarGrid"></div>
        </div>
        </div>

        <!-- ================= SELECTED DATE TASKS ================= -->
        <div class="selected-date-box">
            <h5 id="selectedDateTitle">üìå Click a date to see tasks</h5>
            <ul id="selectedTaskList"></ul>
        </div>

        <!-- ================= TASK TABLE ================= -->
        <table class="task-table mt-4">
            <thead>
            <tr>
                <th>ID</th>
                <th>Title</th>
                <th>Description</th>
                <th>Due Date</th>
                <th>Status</th>
                <th>Priority</th>
                <th>Created At</th>
                <th>Actions</th>
            </tr>
            </thead>

            <tbody>
            <tr th:if="${tasks.empty}">
                <td colspan="8" class="text-center">No tasks found</td>
            </tr>

            <tr th:each="task : ${tasks}">
                <td data-label="ID" th:text="${task.id}"></td>

                <td data-label="Title" th:text="${task.title}"></td>

                <td data-label="Description" th:text="${task.description}"></td>

                <td data-label="Due Date"
                    th:text="${#temporals.format(task.dueDate, 'dd-MM-yyyy')}"></td>

                <td data-label="Status">
        <span class="badge"
              th:text="${task.status}"
              th:classappend="' status-' + ${task.status}">
        </span>
                </td>

                <td data-label="Priority">
        <span class="badge"
              th:text="${task.priority}"
              th:classappend="' priority-' + ${task.priority}">
        </span>
                </td>

                <td data-label="Created At"
                    th:text="${#temporals.format(task.createdAt, 'dd-MM-yyyy HH:mm')}"></td>

                <td data-label="Actions" class="actions">
                    <a class="btn btn-sm btn-outline-info"
                       th:href="@{/api/tasks/view/{id}(id=${task.id})}">View</a>

                    <span th:if="${session.userId != null}">
            <a class="btn btn-sm btn-outline-primary"
               th:href="@{/api/tasks/edit/{id}(id=${task.id})}">Edit</a>

            <a class="btn btn-sm btn-outline-success"
               th:href="@{/api/tasks/markdone/{id}(id=${task.id})}">Mark Done</a>

            <a class="btn btn-sm btn-outline-danger"
               th:href="@{/api/tasks/delete/{id}(id=${task.id})}"
               onclick="return confirm('Delete this task?');">Delete</a>
        </span>
                </td>
            </tr>

            </tbody>
        </table>

        <!-- ================= PAGINATION ================= -->
        <div class="pagination">
            <a th:if="${taskPage.hasPrevious()}"
               th:href="@{/api/tasks/tasks(
                   page=${taskPage.number - 1},
                   size=${taskPage.size},
                   keyword=${keyword},
                   status=${status},
                   priority=${priority}
               )}"
               class="btn btn-sky">Previous</a>

            <span>
                Page <b th:text="${taskPage.number + 1}"></b> /
                <b th:text="${taskPage.totalPages}"></b>
            </span>

            <a th:if="${taskPage.hasNext()}"
               th:href="@{/api/tasks/tasks(
                   page=${taskPage.number + 1},
                   size=${taskPage.size},
                   keyword=${keyword},
                   status=${status},
                   priority=${priority}
               )}"
               class="btn btn-sky">Next</a>
        </div>

    </div>
</div>

<!-- ================= DATA FOR CALENDAR ================= -->
<script th:inline="javascript">
    const tasks = [[${tasks}]];
</script>

<!-- ================= CALENDAR LOGIC ================= -->
<script>
    function formatDate(dueDate) {
        if (!dueDate) return null;
        if (typeof dueDate === "string") return dueDate.substring(0, 10);
        return `${dueDate.year}-${String(dueDate.monthValue).padStart(2,'0')}-${String(dueDate.dayOfMonth).padStart(2,'0')}`;
    }

    let currentDate = new Date();
    let selectedDate = null;

    function renderCalendar() {
        const grid = document.getElementById("calendarGrid");
        grid.innerHTML = "";

        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        const today = new Date();

        document.getElementById("monthYear").innerText =
            currentDate.toLocaleDateString("en-US", { month: "long", year: "numeric" });

        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();

        for (let i = 0; i < firstDay; i++) {
            const empty = document.createElement("div");
            empty.className = "calendar-day";
            empty.style.visibility = "hidden";
            grid.appendChild(empty);
        }

        for (let day = 1; day <= daysInMonth; day++) {
            const cell = document.createElement("div");
            cell.className = "calendar-day";

            const dateStr = `${year}-${String(month + 1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;

            if (
                day === today.getDate() &&
                month === today.getMonth() &&
                year === today.getFullYear()
            ) cell.classList.add("today");

            if (selectedDate === dateStr) cell.style.outline = "2px solid #6366f1";

            cell.innerHTML = `<strong>${day}</strong>`;

            cell.onclick = () => {
                selectedDate = dateStr;
                if (!document.querySelector(".calendar-wrapper").classList.contains("open")) return;

                const box = document.querySelector(".selected-date-box");
                const list = document.getElementById("selectedTaskList");
                const title = document.getElementById("selectedDateTitle");

                box.style.display = "block";
                list.innerHTML = "";
                title.innerText = `üìå Tasks on ${dateStr}`;

                let found = false;

                tasks.forEach(t => {
                    if (formatDate(t.dueDate) === dateStr) {
                        const li = document.createElement("li");
                        li.innerHTML = `
                            <strong>${t.title}</strong>
                            <span class="badge priority-${t.priority}">${t.priority}</span>
                            <span class="badge status-${t.status}">
                                ${t.status.replace("_"," ")}
                            </span>
                        `;
                        list.appendChild(li);
                        found = true;
                    }
                });

                if (!found) {
                    const li = document.createElement("li");
                    li.innerText = "No tasks for this date";
                    list.appendChild(li);
                }

                renderCalendar();
            };

            tasks.forEach(t => {
                if (formatDate(t.dueDate) === dateStr) {
                    const tag = document.createElement("div");
                    tag.className = `cal-task ${t.priority}`;
                    tag.innerText = t.title;
                    cell.appendChild(tag);
                }
            });

            grid.appendChild(cell);
        }
    }

    document.getElementById("prevMonth").onclick = () => {
        currentDate.setMonth(currentDate.getMonth() - 1);
        renderCalendar();
    };

    document.getElementById("nextMonth").onclick = () => {
        currentDate.setMonth(currentDate.getMonth() + 1);
        renderCalendar();
    };
</script>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        const toggleBtn = document.getElementById("toggleCalendarBtn");
        const calendarWrapper = document.querySelector(".calendar-wrapper");
        const selectedBox = document.querySelector(".selected-date-box");

        let open = false;

        toggleBtn.onclick = () => {
            open = !open;
            calendarWrapper.classList.toggle("open", open);
            selectedBox.style.display = open ? "block" : "none";
            toggleBtn.innerText = open ? "‚ùå Close Calendar" : "üìÖ Open Calendar";
            if (open) setTimeout(renderCalendar, 150);
        };
    });
</script>

<!-- ================= FOOTER ================= -->
<div th:replace="~{fragments/layout :: footer}"></div>

</body>
</html>
